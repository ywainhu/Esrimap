<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>
      Select features by rectangle | Sample | ArcGIS API for JavaScript 4.25
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.25/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.25/"></script>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #viewDiv {
        height: 50%;
        width: 100%;
      }

      .container {
        height: 50%;
        width: 100%;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/CSVLayer",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/widgets/Sketch/SketchViewModel",
        "esri/Graphic",
        "esri/widgets/FeatureTable",
        "esri/Basemap",
        "esri/geometry/geometryEngineAsync",
        "esri/widgets/FeatureForm",
        "esri/form/FormTemplate"
      ], function (
        Map,
        MapView,
        CSVLayer,
        FeatureLayer,
        GraphicsLayer,
        SketchViewModel,
        Graphic,
        FeatureTable,
        Basemap,
        geometryEngineAsync,
        FeatureForm,  
        FormTemplate
      ) {
        // Use the states featurealayer as a basemap
        const states = new FeatureLayer({
          url: "https://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer/2",
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-fill",
              color: "#f0ebe4",
              outline: {
                color: "#DCDCDC",
                width: "0.5px"
              }
            }
          },
          spatialReference: {
            wkid: 102003
          },
          effect: "drop-shadow(-10px, 10px, 6px gray)"
        });

        // national parks csv layer
        const csvLayer = new CSVLayer({
          url: "https://ubatsukh.github.io/arcgis-js-api-demos/devsummit2021/csvLayer-nps/data/nps_establishments.csv",
          delimiter: ",",
          popupTemplate: {
            title: "{unit_name}",
            content: "Established on <b>{date_est}</b> <br/><br/> {description}"
          },
          formTemplate: {
            // Autocasts to new FormTemplate
            title: "Damage assessments",
            description: "Provide information for insurance",
            elements: [
              {
                // Autocasts to new GroupElement
                type: "group",
                label: "Park Information",
                description: "Field inspector information",
                elements: [
                  {
                    // Autocasts to new FieldElement
                    type: "field",
                    fieldName: "Name",
                    label: "name"
                  }]
              }
            ]
          }
        });

        let csvLayerView;
        csvLayer
          .when(() => {
            view.whenLayerView(csvLayer).then(function (layerView) {
              csvLayerView = layerView;
            });
          })
          .catch(errorCallback);

        const map = new Map({
          basemap: new Basemap({
            baseLayers: [states]
          }),
          layers: [csvLayer]
        });

        // initialize the view with USA Contiguous Albers Equal Area Conic
        // projection and set the extent to the states
        const view = new MapView({
          container: "viewDiv",
          map: map,
          extent: {
            type: "extent",
            spatialReference: {
              wkid: 102003
            },
            xmax: 2275062,
            xmin: -2752064,
            ymax: 1676207,
            ymin: -1348080
          },
          constraints: {
            snapToZoom: false,
            minScale: 50465153
          },
          spatialReference: {
            wkid: 102003
          },
          background: {
            color: "white"
          }
        });

        const form = new FeatureForm({
          view: view, // required if using Arcade expressions using the $map global variable
          container: "form",
          groupDisplay: "sequential", // only display one group at a time
          layer: csvLayer
        });

        // create a new instance of a FeatureTable
        const featureTable = new FeatureTable({
          view: view,
          layer: csvLayer,
          highlightOnRowSelectEnabled: false,
          fieldConfigs: [
            {
              name: "unit_name",
              label: "Name"
            },
            {
              name: "state",
              label: "State"
            },
            {
              name: "region",
              label: "Region"
            },
            {
              name: "unit_type",
              label: "Type"
            },
            {
              name: "created_by",
              label: "Created by"
            },
            {
              name: "date_est",
              label: "Established date"
            },
            {
              name: "description",
              label: "Description"
            },
            {
              name: "caption",
              label: "Caption"
            }
          ],
          container: document.getElementById("tableDiv")
        });

        // this array will keep track of selected feature objectIds to
        // sync the layerview feature effects and feature table selection
        let features = [];

        // Listen for the table's selection-change event
        featureTable.on("selection-change", (changes) => {
          // if the feature is unselected then remove the objectId
          // of the removed feature from the features array
          changes.removed.forEach((item) => {
            const data = features.find((data) => {
              return data === item.objectId;
            });
            if (data) {
              features.splice(features.indexOf(data), 1);
            }
          });

          // If the selection is added, push all added selections to array
          changes.added.forEach((item) => {
            features.push(item.objectId);
          });

          // set excluded effect on the features that are not selected in the table
          csvLayerView.featureEffect = {
            filter: {
              objectIds: features
            },
            excludedEffect: "blur(5px) grayscale(90%) opacity(40%)"
          };
        });

        // polygonGraphicsLayer will be used by the sketchviewmodel
        // show the polygon being drawn on the view
        const polygonGraphicsLayer = new GraphicsLayer();
        map.add(polygonGraphicsLayer);

        // add the select by rectangle button the view
        view.ui.add("select-by-rectangle", "top-left");
        const selectButton = document.getElementById("select-by-rectangle");

        // click event for the select by rectangle button
        selectButton.addEventListener("click", () => {
          view.popup.close();
          sketchViewModel.create("rectangle");
        });

        // add the clear selection button the view
        view.ui.add("clear-selection", "top-left");
        document
          .getElementById("clear-selection")
          .addEventListener("click", () => {
            featureTable.clearSelection();
            featureTable.filterGeometry = null;
            polygonGraphicsLayer.removeAll();
          });

        // create a new sketch view model set its layer
        const sketchViewModel = new SketchViewModel({
          view: view,
          layer: polygonGraphicsLayer
        });

        // Once user is done drawing a rectangle on the map
        // use the rectangle to select features on the map and table
        sketchViewModel.on("create", async (event) => {
          if (event.state === "complete") {
            // this polygon will be used to query features that intersect it
            const geometries = polygonGraphicsLayer.graphics.map(function (
              graphic
            ) {
              return graphic.geometry;
            });
            const queryGeometry = await geometryEngineAsync.union(
              geometries.toArray()
            );
            selectFeatures(queryGeometry);
          }
        });

        // This function is called when user completes drawing a rectangle
        // on the map. Use the rectangle to select features in the layer and table
        function selectFeatures(geometry) {
          if (csvLayerView) {
            // create a query and set its geometry parameter to the
            // rectangle that was drawn on the view
            const query = {
              geometry: geometry,
              outFields: ["*"]
            };

            // query graphics from the csv layer view. Geometry set for the query
            // can be polygon for point features and only intersecting geometries are returned
            csvLayerView
              .queryFeatures(query)
              .then((results) => {
                if (results.features.length === 0) {
                  clearSelection();
                } else {
                  // pass in the query results to the table by calling its selectRows method.
                  // This will trigger FeatureTable's selection-change event
                  // where we will be setting the feature effect on the csv layer view
                  featureTable.filterGeometry = geometry;
                  featureTable.selectRows(results.features);
                  editFeature = results.features;
                  form.feature = editFeature;
                  
                }
              })
              .catch(errorCallback);
          }
        }

        function errorCallback(error) {
          console.log("error happened:", error.message);
        }

                // Listen to the feature form's submit event.
        form.on("submit", () => {
          if (editFeature) {
            // Grab updated attributes from the form.
            const updated = form.getValues();

            // Loop through updated attributes and assign
            // the updated values to feature attributes.
            Object.keys(updated).forEach((name) => {
              editFeature.attributes[name] = updated[name];
            });

            // Setup the applyEdits parameter with updates.
            const edits = {
              updateFeatures: [editFeature]
            };
            applyAttributeUpdates(edits);
          }
        });

                // Call FeatureLayer.applyEdits() with specified params.
        function applyAttributeUpdates(params) {
          document.getElementById("btnUpdate").style.cursor = "progress";
          featureLayer
            .applyEdits(params)
            .then((editsResult) => {
              // Get the objectId of the newly added feature.
              // Call selectFeature function to highlight the new feature.
              if (editsResult.addFeatureResults.length > 0) {
                const objectId = editsResult.addFeatureResults[0].objectId;
                selectFeature(objectId);
              }
              document.getElementById("btnUpdate").style.cursor = "pointer";
            })
            .catch((error) => {
              console.log("===============================================");
              console.error(
                "[ applyEdits ] FAILURE: ",
                error.code,
                error.name,
                error.message
              );
              console.log("error = ", error);
              document.getElementById("btnUpdate").style.cursor = "pointer";
            });
        }

        // this is called from CSVLayer constructor
        // tree CIM symbol
        view.ui.add("update", "top-right");
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div
      id="select-by-rectangle"
      class="esri-widget esri-widget--button esri-widget esri-interactive"
      title="Select features by rectangle"
    >
      <span class="esri-icon-checkbox-unchecked"></span>
    </div>
    <div
      id="clear-selection"
      class="esri-widget esri-widget--button esri-widget esri-interactive"
      title="Clear selection"
    >
      <span class="esri-icon-erase"></span>
    </div>
    <div class="container">
      <div id="tableDiv"></div>
    </div>
    <div id="update" class="esri-widget esri-hidden">
      <div id="form" class="scroller esri-component"></div>
      <input
        type="button"
        class="esri-button"
        value="Update data"
        id="btnUpdate"
      />
    </div>
  </body>
</html>
